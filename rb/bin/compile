#!/usr/bin/env ruby

$LOAD_PATH.unshift("./rb")

require 'yaml'
require 'require_all'
require_all Dir[File.dirname(__FILE__) + '/../lib/**/*.rb']

def compile_files(*files)
  definitions = files.map do |f|
    begin
      YAML.load(File.read(f))
    rescue Exception => e
      $stderr.puts "Unable to parse file: #{f}."
      raise e
    end
  end.reduce {|a,b| a.concat b}

  h_messages = definitions.find_all {|d| d["message"]}
  messages = h_messages.map do |m|
    begin
      Message.from_hash(m)
    rescue Exception => e
      $stderr.puts "Not a message: #{m}."
      raise e
    end
  end

  h_groups = definitions.find_all {|d| d["group"]}
  groups = h_groups.map do |g|
    begin
      Group.from_hash(g)
    rescue Exception => e
      $stderr.puts "Not a group: #{g}."
      raise e
    end
  end

  c = CFormatter.new("cauterize_example")

  formatted = messages.map { |req| req.format }
  # groups.each { |grp| grp.format_enumeration(c) }
  # groups.each { |grp| grp.format_struct(c) }
  # groups.each { |grp| grp.format_packer(c) }
  # groups.each { |grp| grp.format_unpacker(c) }

  formatted.each {|f| puts f.h_file}
  # formatted.each {|f| puts f.c_file}
  # formatted.each {|f| puts f.cs_file}
end

compile_files(*ARGV)
